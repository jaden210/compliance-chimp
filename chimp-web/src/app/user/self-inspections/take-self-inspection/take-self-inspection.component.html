@if (!inspection?.id) {
  <div class="loading-container">
    <mat-spinner diameter="48"></mat-spinner>
  </div>
} @else {
  <div class="inspection-page">
    <!-- Header -->
    <header class="inspection-header">
      <button mat-icon-button class="back-btn" (click)="saveAndLeave()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-content">
        <h1 class="inspection-title">{{ selfInspection?.title }}</h1>
        <p class="inspection-meta">{{ inspection?.createdAt?.toDate() | date:'MMM d, y' }}</p>
      </div>
      <button mat-icon-button class="menu-btn" [matMenuTriggerFor]="menu">
        <mat-icon>more_vert</mat-icon>
      </button>
      <mat-menu #menu="matMenu">
        <button mat-menu-item (click)="saveAndLeave()">
          <mat-icon>pause</mat-icon>
          <span>Save & Exit</span>
        </button>
      </mat-menu>
    </header>

    <!-- Progress Bar -->
    <div class="progress-section">
      <div class="progress-track">
        <div class="progress-fill" [style.width.%]="inspection?.completedPercent || 0"></div>
      </div>
      <span class="progress-label">{{ count }}</span>
    </div>

    <!-- Question Content -->
    <main class="question-content">
      <!-- Category Navigation (collapsible on mobile) -->
      <button class="category-toggle" (click)="showCategories = !showCategories">
        <mat-icon>{{ showCategories ? 'expand_less' : 'list' }}</mat-icon>
        <span>{{ aCategory?.subject }}</span>
        <mat-icon class="chevron">chevron_right</mat-icon>
      </button>

      @if (showCategories) {
        <div class="categories-drawer">
          <mat-nav-list>
            @for (category of inspection.categories; track category.subject) {
              <mat-list-item 
                class="category-item"
                [class.complete]="category.finished"
                (click)="toggleCategory(category)">
                <mat-icon matListItemIcon [class.complete]="category.finished">
                  {{ category.finished ? 'check_circle' : 'radio_button_unchecked' }}
                </mat-icon>
                <span matListItemTitle>{{ category.subject }}</span>
                <span matListItemMeta>
                  <mat-icon class="expand-icon" [class.expanded]="category.show">expand_more</mat-icon>
                </span>
              </mat-list-item>
              
              @if (category.show) {
                @for (question of category.questions; track question.name) {
                  <mat-list-item 
                    class="question-item"
                    [class.active]="aQuestion?.name === question.name"
                    [class.answered]="question.answer !== undefined"
                    [class.compliant]="question.answer === true"
                    [class.non-compliant]="question.answer === false"
                    (click)="selectQuestion(question); showCategories = false">
                    <mat-icon matListItemIcon 
                      [class.unanswered]="question.answer === undefined"
                      [class.compliant]="question.answer === true"
                      [class.non-compliant]="question.answer === false">
                      @if (question.answer === undefined) {
                        circle
                      } @else if (question.answer === true) {
                        check_circle
                      } @else {
                        error
                      }
                    </mat-icon>
                    <span matListItemTitle class="question-text-item">{{ question.name }}</span>
                  </mat-list-item>
                }
              }
            }
          </mat-nav-list>
        </div>
      }

      <!-- Question Card -->
      <div class="question-card">
        <p class="question-text">{{ aQuestion?.name }}</p>

        <!-- Attached Images -->
        @if (aQuestion?.images?.length) {
          <div class="images-row">
            @for (image of aQuestion.images; track image) {
              <div class="image-thumb">
                <img [src]="image" alt="Attached image">
                <button class="remove-image" (click)="removeImage(image)">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            }
          </div>
        }

        @if (loading) {
          <mat-progress-bar mode="indeterminate" class="upload-bar"></mat-progress-bar>
        }
      </div>
    </main>

    <!-- Response Panel (Fixed Bottom) -->
    <div class="response-panel">
      <!-- Answer Buttons -->
      <div class="answer-section">
        <span class="answer-label">Is this compliant?</span>
        <div class="answer-buttons">
          <button 
            mat-stroked-button 
            class="answer-btn yes-btn"
            [class.selected]="aQuestion?.answer === true"
            (click)="answerQuestion(true)">
            <mat-icon>check_circle</mat-icon>
            Yes
          </button>
          <button 
            mat-stroked-button 
            class="answer-btn no-btn"
            [class.selected]="aQuestion?.answer === false"
            (click)="answerQuestion(false)">
            <mat-icon>cancel</mat-icon>
            No
          </button>
        </div>
      </div>

      <!-- Comment & Actions -->
      <div class="comment-box">
        <textarea
          [(ngModel)]="aQuestion.comment"
          placeholder="Add a comment (optional)"
          rows="2"
        ></textarea>
        <div class="action-buttons">
          <button mat-icon-button class="attach-btn" (click)="uploadImage()">
            <mat-icon>add_photo_alternate</mat-icon>
          </button>
          <button 
            mat-fab 
            color="primary" 
            class="next-btn"
            (click)="nextQuestion()">
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </div>

      <!-- Finish Button -->
      @if (inspection?.completedPercent === 100) {
        <button mat-flat-button color="accent" class="finish-btn" (click)="finishAndLeave()">
          <mat-icon>check</mat-icon>
          Finish Inspection
        </button>
      }
    </div>

    <!-- Hidden file input -->
    <input 
      type="file" 
      id="questionImage" 
      accept=".png,.jpg,.jpeg" 
      #questionImage 
      (change)="uploadQuestionImage($event)" 
      hidden>
  </div>
}
