@if (loading()) {
  <div class="loading-container">
    <mat-spinner diameter="48"></mat-spinner>
  </div>
} @else {
  <div class="injury-report-page">
    <!-- Header -->
    <header class="report-header">
      <button mat-icon-button class="back-btn" (click)="quit()">
        <mat-icon>close</mat-icon>
      </button>
      <div class="header-content">
        <h1 class="report-title">{{ title }}</h1>
        <p class="report-meta">
          Question {{ index() + 1 }} of {{ questions.length }}
        </p>
      </div>
    </header>

    <!-- Progress Bar -->
    <div class="progress-bar-container">
      <div class="progress-bar" [style.width.%]="progress()"></div>
    </div>

    <!-- Content Area -->
    <main class="report-content">
      @if (question(); as q) {
        <!-- Question Card -->
        <div class="question-card">
          <p class="question-text">{{ q.description }}</p>
        </div>

        <!-- Radio Options -->
        @if (q.type === Type.radio) {
          <div class="options-container">
            <div class="options-group">
              @for (option of q.radioOptions; track option.value) {
                <div 
                  class="option-card" 
                  [class.selected]="q.value === option.value"
                  (click)="selectOption(q, option.value)">
                  <mat-icon class="option-icon">
                    {{ q.value === option.value ? 'radio_button_checked' : 'radio_button_unchecked' }}
                  </mat-icon>
                  <span class="option-label">{{ option.name }}</span>
                </div>
              }
            </div>
          </div>
        }

        <!-- Date Picker -->
        @if (q.type === Type.date) {
          <div class="input-container">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Select date</mat-label>
              <input
                matInput
                readonly
                (click)="picker.open()"
                (keydown)="$event.preventDefault()"
                [matDatepicker]="picker"
                [(ngModel)]="q.value"
                (ngModelChange)="onValueChange()"
              />
              <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker touchUi #picker (closed)="onValueChange()"></mat-datepicker>
            </mat-form-field>
          </div>
        }

        <!-- Text Input -->
        @if (q.type === Type.text) {
          <div class="input-container">
            <div class="text-input-card">
              <textarea
                id="text-input"
                [(ngModel)]="q.value"
                (ngModelChange)="onValueChange()"
                placeholder="Type your response here..."
                cdkTextareaAutosize
                cdkAutosizeMinRows="3"
                cdkAutosizeMaxRows="8"
              ></textarea>
            </div>
          </div>
        }

        <!-- Photo Upload -->
        @if (q.type === Type.photos) {
          <div class="photos-container">
            <div class="photo-grid">
              <!-- Uploaded Images -->
              @for (image of q.value; track $index) {
                <div class="photo-item">
                  <img [src]="image.imageUrl" alt="Uploaded photo" (click)="viewImage(image.imageUrl)">
                  <button mat-icon-button class="remove-photo-btn" (click)="removeImage($index); $event.stopPropagation()">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              }

              <!-- Add Photo Button -->
              <div class="add-photo-btn" (click)="selectImage()" [class.disabled]="uploading()">
                @if (uploading()) {
                  <mat-spinner diameter="24"></mat-spinner>
                } @else {
                  <mat-icon>add_photo_alternate</mat-icon>
                  <span>Add Photo</span>
                }
              </div>
            </div>

            <input
              type="file"
              id="photo-input"
              accept="image/*"
              multiple
              (change)="onImagesSelected($event)"
              style="display: none;"
            />
          </div>
        }

        <!-- Signature (embedded canvas) -->
        @if (q.type === Type.signature) {
          <div class="signature-area">
            @if (q.value) {
              <div class="signature-image-container">
                <img [src]="q.value" alt="Your signature">
              </div>
              <button mat-stroked-button class="clear-signature-btn" (click)="clearSignature()">
                <mat-icon>refresh</mat-icon>
                Sign Again
              </button>
            } @else {
              <canvas #signatureCanvas class="signature-canvas"></canvas>
              @if (signatureComplete()) {
                <button mat-stroked-button class="clear-signature-btn" (click)="clearSignaturePad()">
                  <mat-icon>refresh</mat-icon>
                  Clear
                </button>
              }
            }
          </div>
        }
      }
    </main>

    <!-- Action Panel -->
    <div class="action-panel">
      @if (uploading()) {
        <mat-progress-bar mode="indeterminate" class="upload-progress"></mat-progress-bar>
      }

      <div class="action-buttons">
        @if (question()?.getStarted) {
          <button mat-flat-button color="primary" class="action-btn primary-btn" (click)="skip()">
            Get Started
            <mat-icon>arrow_forward</mat-icon>
          </button>
        } @else if (question()?.submit) {
          <button 
            mat-flat-button 
            color="primary" 
            class="action-btn primary-btn"
            (click)="submitReport()"
            [disabled]="submitting()"
          >
            @if (submitting()) {
              <ng-container>
                <mat-spinner diameter="20"></mat-spinner>
                <span>Submitting...</span>
              </ng-container>
            } @else {
              Submit Report
            }
          </button>
        } @else {
          <!-- Back Button -->
          @if (index() > 0) {
            <button mat-stroked-button class="action-btn back-btn" (click)="goBack()">
              <mat-icon>arrow_back</mat-icon>
              Back
            </button>
          }

          <div class="action-spacer"></div>

          <!-- Skip Button -->
          @if (question()?.skip) {
            <button mat-button class="action-btn skip-btn" (click)="skip()">
              Skip
            </button>
          }

          <!-- Next Button -->
          @if (question()?.next) {
            <button 
              mat-flat-button 
              color="primary" 
              class="action-btn next-btn"
              (click)="next()"
              [disabled]="!canGoNext() || uploading()"
            >
              Next
              <mat-icon>arrow_forward</mat-icon>
            </button>
          }
        }
      </div>
    </div>
  </div>
}
