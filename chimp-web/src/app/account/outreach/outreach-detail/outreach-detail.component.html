<div class="window" *ngIf="job">
  <div class="detail-header">
    <button mat-icon-button (click)="goBack()" matTooltip="Back to list">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <div class="detail-title">{{ job.niche | titlecase }} — {{ job.region }}</div>
    <div class="flex"></div>
    <button
      mat-icon-button
      *ngIf="job.results?.length"
      (click)="sanitizeEmails()"
      [disabled]="sanitizing"
      matTooltip="Sanitize emails"
    >
      <mat-icon>{{ sanitizing ? 'hourglass_empty' : 'cleaning_services' }}</mat-icon>
    </button>
    <button
      mat-icon-button
      *ngIf="job.results?.length && hasUnverifiedEmails()"
      (click)="verifyEmails()"
      [disabled]="verifying"
      matTooltip="Verify email deliverability"
    >
      <mat-icon>{{ verifying ? 'hourglass_empty' : 'verified' }}</mat-icon>
    </button>
    <button
      mat-icon-button
      *ngIf="job.status === 'complete'"
      (click)="downloadCsv()"
      matTooltip="Download CSV"
    >
      <mat-icon>download</mat-icon>
    </button>
  </div>
  <!-- Interrupted banner -->
  <div class="interrupted-banner" *ngIf="service.isInterrupted(job)">
    <mat-icon>warning_amber</mat-icon>
    <div class="interrupted-text">
      <strong>{{ service.getStatusLabel(job.status, job) }}</strong>
      <span>The scraper process was interrupted. Re-open the Lead Scraper tool on your computer and click Resume to pick up where it left off.</span>
    </div>
    <span class="interrupted-pct">{{ service.getProgressPercent(job) | number:'1.0-0' }}%</span>
  </div>
  <mat-progress-bar
    *ngIf="service.isInterrupted(job)"
    mode="determinate"
    [value]="service.getProgressPercent(job)"
    color="primary"
  ></mat-progress-bar>

  <!-- Progress section (active) -->
  <div class="progress-section" *ngIf="service.isRunning(job.status) && !service.isInterrupted(job)">
    <div class="progress-header">
      <span
        class="status-dot"
        [style.background]="service.getStatusColor(job.status, job)"
      ></span>
      <span class="status-label">{{ service.getStatusLabel(job.status, job) }}</span>
      <span class="progress-pct">{{ service.getProgressPercent(job) | number:'1.0-0' }}%</span>
    </div>
    <mat-progress-bar
      mode="determinate"
      [value]="service.getProgressPercent(job)"
      color="accent"
    ></mat-progress-bar>
  </div>

  <!-- Stats cards -->
  <div class="stats-row" *ngIf="job.progress">
    <div class="stat-card">
      <div class="stat-number">{{ job.progress.placesFound || 0 }}</div>
      <div class="stat-text">Businesses Found</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ job.progress.placesScraped || 0 }}</div>
      <div class="stat-text">Details Scraped</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ job.progress.totalWithPhone || 0 }}</div>
      <div class="stat-text">Phone Numbers</div>
    </div>
    <div
      class="stat-card accent clickable-card"
      (click)="openCampaign()"
      matTooltip="Open email campaign"
    >
      <div class="stat-number">{{ job.progress.totalWithEmail || job.progress.emailsFound || 0 }}</div>
      <div class="stat-text">
        Emails Found
        <mat-icon class="card-action-icon">mail_outline</mat-icon>
      </div>
    </div>
  </div>

  <!-- Results table -->
  <div class="results-section" *ngIf="job.results?.length">
    <div class="results-header">
      <h3>Results ({{ dataSource.filteredData.length }})</h3>
      <div class="results-header-controls">
        <mat-form-field class="status-filter" subscriptSizing="dynamic">
          <mat-select
            [(ngModel)]="statusFilter"
            (ngModelChange)="applyFilter()"
          >
            <mat-option value="all">All</mat-option>
            <mat-option value="sendable">Sendable</mat-option>
            <mat-option value="deliverable">Deliverable</mat-option>
            <mat-option value="custom">Custom</mat-option>
            <mat-option value="risky">Risky</mat-option>
            <mat-option value="undeliverable">Undeliverable</mat-option>
            <mat-option value="unknown">Unknown</mat-option>
            <mat-option value="not_verified">Not Verified</mat-option>
            <mat-option value="no_email">No Email</mat-option>
            <mat-option value="skipped">Skipped</mat-option>
          </mat-select>
        </mat-form-field>
        <div class="search-box">
          <mat-icon>search</mat-icon>
          <input
            [(ngModel)]="searchTerm"
            (ngModelChange)="applyFilter()"
            placeholder="Filter results..."
          />
        </div>
      </div>
    </div>

    <div class="table-container">
      <table mat-table [dataSource]="dataSource" matSort>
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Business Name</th>
          <td mat-cell *matCellDef="let row">
            <span class="business-name">{{ row.name }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="phone">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Phone</th>
          <td mat-cell *matCellDef="let row; let i = index">
            <div class="editable-cell" *ngIf="editingCell?.row === i && editingCell?.col === 'phone'; else showPhone">
              <input
                class="inline-edit"
                [(ngModel)]="editValue"
                (blur)="saveEdit(row, 'phone')"
                (keydown.enter)="saveEdit(row, 'phone')"
                (keydown.escape)="cancelEdit()"
                #editInput
              />
            </div>
            <ng-template #showPhone>
              <span
                class="clickable"
                *ngIf="row.phone"
                (click)="copyPhone(row.phone)"
                matTooltip="Click to copy, double-click to edit"
                (dblclick)="startEdit(i, 'phone', row.phone)"
              >{{ row.phone }}</span>
              <span
                class="add-value"
                *ngIf="!row.phone"
                (click)="startEdit(i, 'phone', '')"
                matTooltip="Add phone"
              >+ add</span>
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Email</th>
          <td mat-cell *matCellDef="let row; let i = index">
            <div class="editable-cell" *ngIf="editingCell?.row === i && editingCell?.col === 'email'; else showEmail">
              <input
                class="inline-edit"
                [(ngModel)]="editValue"
                (blur)="saveEdit(row, 'email')"
                (keydown.enter)="saveEdit(row, 'email')"
                (keydown.escape)="cancelEdit()"
                #editInput
              />
            </div>
            <ng-template #showEmail>
              <span class="email-cell" *ngIf="row.email">
                <mat-icon
                  *ngIf="row.emailVerification"
                  class="email-status status-{{ row.emailVerification.status }}"
                  [matTooltip]="getVerificationTooltip(row.emailVerification)"
                >{{ getVerificationIcon(row.emailVerification) }}</mat-icon>
                <mat-icon
                  *ngIf="!row.emailVerification"
                  class="email-status mark-custom-btn"
                  matTooltip="Mark as custom (approve for sending)"
                  (click)="markAsCustom(row)"
                >add_task</mat-icon>
                <span
                  class="clickable email"
                  (click)="copyEmail(row.email)"
                  matTooltip="Click to copy, double-click to edit"
                  (dblclick)="startEdit(i, 'email', row.email)"
                >{{ row.email }}</span>
              </span>
              <span class="no-email-actions" *ngIf="!row.email">
                <span
                  class="add-value"
                  (click)="startEdit(i, 'email', '')"
                  matTooltip="Add email"
                >+ add</span>
                <mat-icon
                  class="skip-btn"
                  [class.skipped]="row.skipped"
                  (click)="skipResult(row)"
                  [matTooltip]="row.skipped ? 'Already skipped' : 'Skip — no email found'"
                >block</mat-icon>
              </span>
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
          <td mat-cell *matCellDef="let row">
            <span
              *ngIf="row.emailVerification"
              class="verification-badge badge-{{ row.emailVerification.status }}"
            >
              <mat-icon class="badge-icon">{{ getVerificationIcon(row.emailVerification) }}</mat-icon>
              <span class="badge-label">{{ row.emailVerification.status }}</span>
              <span class="badge-score" *ngIf="row.emailVerification.score != null">{{ row.emailVerification.score }}</span>
            </span>
            <span
              *ngIf="!row.emailVerification && row.email"
              class="verification-badge badge-pending"
            >
              <mat-icon class="badge-icon">schedule</mat-icon>
              <span class="badge-label">unverified</span>
            </span>
            <span
              *ngIf="!row.email && row.skipped"
              class="verification-badge badge-skipped"
            >
              <mat-icon class="badge-icon">block</mat-icon>
              <span class="badge-label">skipped</span>
            </span>
            <span
              *ngIf="!row.email && !row.skipped"
              class="verification-badge badge-none"
            >
              <mat-icon class="badge-icon">mail_outline</mat-icon>
              <span class="badge-label">no email</span>
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="website">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Website</th>
          <td mat-cell *matCellDef="let row">
            <span
              class="clickable link"
              *ngIf="row.website"
              (click)="openWebsite(row.website)"
              matTooltip="Open website"
            >{{ row.website | slice:0:35 }}{{ row.website?.length > 35 ? '...' : '' }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="address">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Address</th>
          <td mat-cell *matCellDef="let row">
            <span
              class="clickable"
              *ngIf="row.address"
              (click)="openMaps(row.googleMapsUrl)"
              matTooltip="Open in Google Maps"
            >{{ row.address | slice:0:40 }}{{ row.address?.length > 40 ? '...' : '' }}</span>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns" [class.row-skipped]="row.skipped"></tr>
      </table>
    </div>
  </div>

  <!-- Empty state for running jobs -->
  <div class="empty-state" *ngIf="!job.results?.length && service.isRunning(job.status) && !service.isInterrupted(job)">
    <mat-icon>hourglass_top</mat-icon>
    <p>Scraper is running. Results will appear here as they come in.</p>
  </div>

  <!-- Empty state for interrupted jobs -->
  <div class="empty-state" *ngIf="!job.results?.length && service.isInterrupted(job)">
    <mat-icon>pause_circle_outline</mat-icon>
    <p>This job was interrupted before results were collected. Re-open the Lead Scraper tool and click Resume to continue.</p>
  </div>

  <!-- Empty state for completed jobs with no results -->
  <div class="empty-state" *ngIf="!job.results?.length && job.status === 'complete'">
    <mat-icon>search_off</mat-icon>
    <p>No results found for this scrape job.</p>
  </div>
</div>
