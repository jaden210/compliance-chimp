<mat-toolbar>
  <button mat-icon-button (click)="goBack()">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <img class="toolbar-logo" src="/assets/complianceChimpLogoLight.png" alt="Compliance Chimp">
  <span class="toolbar-title">
    @switch (mode) {
      @case ('edit') { Edit Inspection }
      @case ('scratch') { Create Inspection }
      @default { Smart Builder }
    }
  </span>
  <div class="flex"></div>
</mat-toolbar>

<div class="page-content">
  <!-- Prefilled Banner -->
  <div class="prefilled-banner" *ngIf="prefilledReason && !showEditor">
    <mat-icon>lightbulb</mat-icon>
    <div class="banner-content">
      <span>{{ prefilledReason }}</span>
    </div>
    <button mat-icon-button (click)="prefilledReason = ''" matTooltip="Dismiss">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Step 1: Describe Your Inspection (Generate mode, before content exists) -->
  <section class="builder-section" *ngIf="mode === 'generate' && !showEditor">
    <div class="section-header">
      <div class="step-badge">1</div>
      <div class="section-info">
        <h2>Describe your inspection</h2>
        <p>Tell us what you want this inspection to cover. You can type or use voice input.</p>
      </div>
    </div>

    <div class="input-area">
      <mat-form-field appearance="outline" class="description-field">
        <mat-label>Inspection description</mat-label>
        <textarea
          matInput
          [(ngModel)]="description"
          rows="4"
          cdkTextareaAutosize
          cdkAutosizeMinRows="3"
          cdkAutosizeMaxRows="10"
          placeholder="e.g., Create a monthly forklift safety inspection covering pre-operation checks, operator safety, and maintenance requirements..."
          [disabled]="isGenerating"
        ></textarea>
      </mat-form-field>

      <button
        *ngIf="recordingSupported"
        mat-fab
        [color]="isRecording ? 'warn' : 'primary'"
        (click)="toggleRecording()"
        [disabled]="isGenerating"
        class="mic-button"
        [matTooltip]="isRecording ? 'Stop recording' : 'Start voice input'"
      >
        <mat-icon>{{ isRecording ? 'stop' : 'mic' }}</mat-icon>
      </button>
    </div>

    <div class="recording-indicator" *ngIf="isRecording">
      <span class="pulse-dot"></span>
      <span>Listening... Speak now</span>
    </div>

    <div class="error-message" *ngIf="error">
      <mat-icon>error_outline</mat-icon>
      {{ error }}
    </div>

    <div class="generating-state" *ngIf="isGenerating">
      <mat-spinner diameter="48"></mat-spinner>
      <h3>Building your inspection checklist...</h3>
      <p>Creating categories and questions tailored to your business.</p>
    </div>

    <div class="action-row" *ngIf="!isGenerating">
      <button
        mat-button
        (click)="switchToScratch()"
        class="scratch-btn"
      >
        <mat-icon>edit_note</mat-icon>
        Write My Own
      </button>
      <button
        mat-flat-button
        color="accent"
        (click)="generateInspection()"
        [disabled]="!description.trim() || isGenerating || isRecording"
        class="generate-btn"
      >
        <mat-icon>construction</mat-icon>
        Draft Inspection
      </button>
    </div>
  </section>

  <!-- Editor Section (shown in edit mode, scratch mode, OR after content is generated) -->
  <section class="editor-section" *ngIf="showEditor || mode === 'edit'">
    <div class="section-header">
      <div class="step-badge success" *ngIf="mode === 'generate'">
        <mat-icon>check</mat-icon>
      </div>
      <div class="section-info">
        @switch (mode) {
          @case ('edit') {
            <h2>Edit your inspection</h2>
            <p>Update the categories, questions, and settings for this inspection.</p>
          }
          @case ('generate') {
            <h2>Inspection generated!</h2>
            <p>Review the categories and questions, then save to your library.</p>
          }
          @default {
            <h2>Create your inspection</h2>
            <p>Add categories and questions for your inspection checklist.</p>
          }
        }
      </div>
      <div class="header-actions">
        <button mat-icon-button
                *ngIf="mode === 'generate'"
                (click)="clearGenerated(); mode = 'generate'"
                matTooltip="Start over"
                class="reset-btn">
          <mat-icon>restart_alt</mat-icon>
        </button>
        <button mat-flat-button
                color="primary"
                (click)="saveInspection()"
                [disabled]="isSaving || !title?.trim() || baseQuestions.length === 0">
          <mat-icon>check</mat-icon>
          {{ isSaving ? 'Saving...' : (mode === 'edit' ? 'Save Changes' : 'Add to Library') }}
        </button>
      </div>
    </div>

    <!-- Configuration -->
    <div class="config-section">
      <div class="config-row">
        <mat-form-field appearance="outline" class="title-field">
          <mat-label>Inspection Title</mat-label>
          <input matInput [(ngModel)]="title" placeholder="Enter a title for this inspection">
        </mat-form-field>

        <mat-form-field appearance="outline" class="frequency-field">
          <mat-label>Frequency</mat-label>
          <input matInput [value]="selectedFrequency" readonly [matMenuTriggerFor]="frequencyMenu" style="cursor: pointer;">
          <mat-icon matSuffix>arrow_drop_down</mat-icon>
        </mat-form-field>
        <mat-menu #frequencyMenu="matMenu">
          @for (option of frequencyOptions; track $index) {
            <button mat-menu-item
                    (click)="onFrequencyChange(option.value)"
                    [class.selected]="selectedFrequency === option.value">
              {{ option.label }}
            </button>
          }
        </mat-menu>
      </div>
    </div>

    <!-- Categories & Questions Editor -->
    <div class="categories-editor">
      <div class="editor-label">
        <mat-icon>checklist</mat-icon>
        <span>Categories &amp; Questions</span>
        <span class="question-total">{{ totalQuestionCount }} question{{ totalQuestionCount !== 1 ? 's' : '' }}</span>
      </div>

      <mat-accordion class="categories-accordion" multi>
        @for (category of baseQuestions; track $index; let catIndex = $index) {
          <mat-expansion-panel
            class="category-panel"
            [expanded]="true">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <input
                  class="category-name-input"
                  [ngModel]="category.subject"
                  (ngModelChange)="onCategoryNameChange(catIndex, $event)"
                  (click)="$event.stopPropagation()"
                  placeholder="Category name...">
                <span class="question-count">{{ category.questions?.length || 0 }}</span>
                <button mat-icon-button
                        class="remove-category-btn"
                        (click)="$event.stopPropagation(); removeCategory(catIndex)"
                        matTooltip="Remove category">
                  <mat-icon>delete_outline</mat-icon>
                </button>
              </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="questions-list">
              @for (question of category.questions; track $index; let qIndex = $index) {
                <div
                  class="question-item">
                  <textarea
                    class="question-input"
                    [ngModel]="question.name"
                    (ngModelChange)="onQuestionChange(catIndex, qIndex, $event)"
                    placeholder="Question text..."
                    cdkTextareaAutosize
                    cdkAutosizeMinRows="1"
                    cdkAutosizeMaxRows="6"></textarea>
                  <button
                    mat-stroked-button
                    class="expected-answer-btn"
                    (click)="toggleExpectedAnswer(catIndex, qIndex)"
                    [matTooltip]="'Compliant answer: ' + (question.expectedAnswer === false ? 'No' : 'Yes')"
                    [class.expects-no]="question.expectedAnswer === false">
                    <mat-icon>{{ question.expectedAnswer === false ? 'close' : 'check' }}</mat-icon>
                    {{ question.expectedAnswer === false ? 'No' : 'Yes' }}
                  </button>
                  <button mat-icon-button
                          class="remove-question-btn"
                          (click)="removeQuestion(catIndex, qIndex)"
                          matTooltip="Remove question">
                    <mat-icon>delete_outline</mat-icon>
                  </button>
                </div>
              }

              <!-- Add Question Row -->
              <div class="add-question-row">
                <mat-form-field appearance="outline" class="new-question-field">
                  <mat-label>Add a question</mat-label>
                  <textarea matInput
                            [(ngModel)]="newQuestionTexts[catIndex]"
                            cdkTextareaAutosize
                            cdkAutosizeMinRows="1"
                            cdkAutosizeMaxRows="4"
                            (keyup.enter)="addQuestion(catIndex)"></textarea>
                </mat-form-field>
                <button mat-mini-fab
                        color="primary"
                        (click)="addQuestion(catIndex)"
                        [disabled]="!newQuestionTexts[catIndex]?.trim()"
                        matTooltip="Add question">
                  <mat-icon>add</mat-icon>
                </button>
              </div>
            </div>
          </mat-expansion-panel>
        }
      </mat-accordion>

      <!-- Add Category Section -->
      <div class="add-category-section">
        <mat-form-field appearance="outline" class="category-name-field">
          <mat-label>Add a new category</mat-label>
          <input matInput
                 [(ngModel)]="newCategoryName"
                 placeholder="e.g., Fire Safety, Equipment Maintenance..."
                 (keyup.enter)="addCategory()">
          <button mat-icon-button
                  matSuffix
                  (click)="openOshaCategoryPicker()"
                  matTooltip="Pick from OSHA categories"
                  *ngIf="getAvailableOshaCategories().length > 0">
            <mat-icon>category</mat-icon>
          </button>
        </mat-form-field>
        <button mat-mini-fab
                color="primary"
                (click)="addCategory()"
                [disabled]="!newCategoryName?.trim()"
                matTooltip="Add category">
          <mat-icon>add</mat-icon>
        </button>
      </div>
    </div>

    <div class="error-message" *ngIf="error">
      <mat-icon>error_outline</mat-icon>
      {{ error }}
    </div>
  </section>
</div>
