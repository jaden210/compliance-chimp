<mat-toolbar>
  <img class="toolbar-logo" src="/assets/complianceChimpLogoLight.png">
  <button mat-icon-button class="toolbar-expand-mobile" (click)="accountService.toggle()"><mat-icon>menu</mat-icon></button>
  <div class="toolbar-title">Self-Inspections</div>
  <div class="flex"></div>
</mat-toolbar>

<div class="window self-inspections-page">
      <!-- Team Members Required Notice -->
      <section class="setup-notice" *ngIf="accountService.teamMembersLoaded && !hasTeamMembers()">
        <div class="setup-card">
          <div class="setup-left">
            <div class="setup-icon">
              <mat-icon>group_add</mat-icon>
            </div>
            <div class="setup-content">
              <h3>Add Your Team First</h3>
              <p>
                To provide personalized inspection recommendations, we need to know who's on your team. 
                Adding members with their job titles helps us identify the right compliance requirements.
              </p>
              <button mat-flat-button routerLink="/account/team">
                <mat-icon>group_add</mat-icon>
                Add Team Members
              </button>
            </div>
          </div>
          <div class="setup-right">
            <div class="benefits-header">With your team added, you'll get:</div>
            <ul class="setup-benefits">
              <li><mat-icon>check_circle</mat-icon> Role-specific inspection recommendations</li>
              <li><mat-icon>check_circle</mat-icon> Compliance coverage for all job functions</li>
              <li><mat-icon>check_circle</mat-icon> Training and inspection tracking by member</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- Get Started Hero - shown when no inspections AND can analyze coverage -->
      <ng-container *ngIf="selfInspections$ | async as heroInspections">
        <section class="get-started-hero" *ngIf="heroInspections.length === 0 && canAnalyzeCoverage() && !autoBuildActive() && !autoBuildProgress()">
          <div class="hero-layout">
            <!-- Left Column - What & Why -->
            <div class="hero-left">
              <div class="hero-kicker">Self-Inspections</div>
              <h1 class="hero-title">Stay ahead of compliance issues before they become problems</h1>
              <p class="hero-intro">
                Self-inspections are recurring checklists that help you identify issues, 
                document corrective actions, and maintain compliance. Regular inspections are the 
                foundation of any effective compliance program.
              </p>
              
              <div class="hero-benefits">
                <div class="benefit-item">
                  <mat-icon>search</mat-icon>
                  <div>
                    <strong>Catch issues early</strong>
                    <span>Identify problems before they become violations or incidents</span>
                  </div>
                </div>
                <div class="benefit-item">
                  <mat-icon>history</mat-icon>
                  <div>
                    <strong>Build a compliance record</strong>
                    <span>Document your efforts with timestamped inspections</span>
                  </div>
                </div>
                <div class="benefit-item">
                  <mat-icon>trending_up</mat-icon>
                  <div>
                    <strong>Track improvements over time</strong>
                    <span>See how your compliance improves with each inspection</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Column - Action -->
            <div class="hero-right">
              <div class="hero-action-card">
                <div class="action-header">
                  <mat-icon>rocket_launch</mat-icon>
                  <h2>Get Started in Seconds</h2>
                </div>
                <p class="action-description">
                  We'll build a complete inspection program tailored to your 
                  <strong>{{ accountService.aTeam?.industry }}</strong> industry and 
                  <strong>{{ accountService.teamMembers?.length }}</strong> team members.
                </p>
                
                <ul class="action-features">
                  <li>
                    <mat-icon>check_circle</mat-icon>
                    <span>Industry-specific checklists</span>
                  </li>
                  <li>
                    <mat-icon>check_circle</mat-icon>
                    <span>Based on your team's job roles</span>
                  </li>
                  <li>
                    <mat-icon>check_circle</mat-icon>
                    <span>Ready to use in under a minute</span>
                  </li>
                </ul>

                <button mat-flat-button color="accent" class="primary-action" (click)="startAutoBuild()" [disabled]="accountService.isReadOnly">
                  <mat-icon>rocket_launch</mat-icon>
                  Build It For Me
                </button>

                <div class="action-divider">
                  <span>or start from scratch</span>
                </div>

                <div class="secondary-actions">
                  <button mat-stroked-button (click)="goToGuide()" [disabled]="accountService.isReadOnly">
                    <mat-icon>construction</mat-icon>
                    Smart Builder
                  </button>
                  <button mat-stroked-button (click)="goToTemplates()" [disabled]="accountService.isReadOnly">
                    <mat-icon>list_alt</mat-icon>
                    Templates
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </ng-container>

      <!-- Normal splash - shown when there ARE inspections and not auto-building -->
      <ng-container *ngIf="selfInspections$ | async as splashInspections">
        <section class="splash" *ngIf="hasTeamMembers() && !autoBuildActive() && splashInspections.length > 0">
          <div class="splash-content">
            <div class="splash-kicker">Self-Inspections</div>
            <div class="splash-title">Turn compliance into a steady rhythm.</div>
            <div class="splash-body">
              Self-inspections are guided checklists that capture how your team is doing. Pick one to review past runs or start a new inspection run.
            </div>
            <div class="splash-actions">
              <button mat-flat-button color="accent" (click)="goToGuide()" [disabled]="accountService.isReadOnly">
                <mat-icon>build</mat-icon>
                Smart Builder
              </button>
              <button mat-stroked-button color="primary" (click)="goToTemplates()" [disabled]="accountService.isReadOnly">
                <mat-icon>list_alt</mat-icon>
                Build from Templates
              </button>
            </div>
          </div>
        </section>
      </ng-container>

      <!-- Auto-Build Progress Section -->
      <section class="auto-build-section" *ngIf="autoBuildActive() || autoBuildProgress()">
        <div class="auto-build-card">
          <!-- Header -->
          <div class="auto-build-header">
            <div class="auto-build-icon" [class.spinning]="autoBuildActive() && !isAutoBuildComplete() && !isAutoBuildError()">
              <mat-icon>{{ isAutoBuildComplete() ? 'check_circle' : isAutoBuildError() ? 'error' : 'auto_awesome' }}</mat-icon>
            </div>
            <div class="auto-build-title-section">
              <h2 class="auto-build-title">
                {{ isAutoBuildComplete() ? 'Build Complete!' : isAutoBuildError() ? 'Build Error' : 'Building Your Inspection Program' }}
              </h2>
              <p class="auto-build-subtitle" *ngIf="autoBuildProgress() as progress">
                {{ progress.currentAction }}
              </p>
            </div>
          </div>

          <!-- Progress Info -->
          <div class="auto-build-progress" *ngIf="autoBuildProgress() as progress">
            <div class="progress-stats">
              <div class="stat">
                <span class="stat-label">Iteration</span>
                <span class="stat-value">{{ progress.iteration }} / {{ progress.maxIterations }}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Coverage</span>
                <span class="stat-value" [class.score-excellent]="progress.currentScore >= 90" [class.score-good]="progress.currentScore >= 70 && progress.currentScore < 90">
                  {{ progress.currentScore }}%
                </span>
              </div>
              <div class="stat">
                <span class="stat-label">Created</span>
                <span class="stat-value">{{ progress.inspectionsCreated }}</span>
              </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar-container">
              <mat-progress-bar 
                [mode]="isAutoBuildComplete() || isAutoBuildError() ? 'determinate' : 'indeterminate'"
                [value]="isAutoBuildComplete() ? 100 : getAutoBuildProgressPercent()">
              </mat-progress-bar>
            </div>

            <!-- Action Log -->
            <div class="auto-build-log">
              <div class="log-header">
                <mat-icon>list</mat-icon>
                Progress Log
              </div>
              <div class="log-entries">
                <div class="log-entry" *ngFor="let entry of progress.log" [ngClass]="entry.type">
                  <mat-icon class="log-icon">
                    {{ entry.type === 'created' ? 'check_circle' : entry.type === 'error' ? 'error' : entry.type === 'analysis' ? 'analytics' : 'info' }}
                  </mat-icon>
                  <span class="log-message">{{ entry.message }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="auto-build-actions">
            <button mat-stroked-button *ngIf="autoBuildActive() && !isAutoBuildComplete() && !isAutoBuildError()" (click)="cancelAutoBuild()">
              <mat-icon>close</mat-icon>
              Cancel
            </button>
            <button mat-flat-button color="primary" *ngIf="isAutoBuildComplete()" (click)="autoBuildProgress.set(null)">
              <mat-icon>visibility</mat-icon>
              View Inspections
            </button>
            <button mat-flat-button color="primary" *ngIf="isAutoBuildError()" (click)="startAutoBuild()">
              <mat-icon>refresh</mat-icon>
              Try Again
            </button>
            <button mat-stroked-button *ngIf="isAutoBuildError()" (click)="autoBuildProgress.set(null); goToGuide()">
              <mat-icon>construction</mat-icon>
              Build Manually
            </button>
          </div>
        </div>
      </section>

      <ng-container *ngIf="selfInspections$ | async as allInspections; else loading">
        <!-- Coverage Analysis Section -->
        <section class="coverage-analysis-section" *ngIf="hasTeamMembers() && hasIndustry()">
          <!-- Loading State -->
          <div class="coverage-loading" *ngIf="coverageLoading() && !(coverageAnalysis$ | async)">
            <mat-spinner diameter="32"></mat-spinner>
            <span>Analyzing your inspection coverage...</span>
          </div>

          <!-- Error State -->
          <div class="coverage-error" *ngIf="coverageError() && !coverageLoading()">
            <mat-icon>error_outline</mat-icon>
            <span>{{ coverageError() }}</span>
            <button mat-stroked-button (click)="refreshCoverageAnalysis()">
              <mat-icon>refresh</mat-icon>
              Retry
            </button>
          </div>

          <!-- Analysis Results -->
          <ng-container *ngIf="coverageAnalysis$ | async as analysis">
            <div class="coverage-card" *ngIf="analysis.success" [class.coverage-collapsed]="coverageCollapsed()">
              
              <!-- Collapsed View -->
              <div class="coverage-collapsed-row" *ngIf="coverageCollapsed()" (click)="toggleCoverageCollapsed()">
                <div class="score-ring score-ring-small" [ngClass]="getScoreColorClass(analysis.score)">
                  <svg viewBox="0 0 36 36" class="circular-chart">
                    <path class="circle-bg"
                      d="M18 2.0845
                         a 15.9155 15.9155 0 0 1 0 31.831
                         a 15.9155 15.9155 0 0 1 0 -31.831"
                    />
                    <path class="circle"
                      [attr.stroke-dasharray]="analysis.score + ', 100'"
                      d="M18 2.0845
                         a 15.9155 15.9155 0 0 1 0 31.831
                         a 15.9155 15.9155 0 0 1 0 -31.831"
                    />
                  </svg>
                  <span class="score-value">{{ analysis.score }}</span>
                </div>
                <div class="collapsed-info">
                  <div class="collapsed-title">
                    <mat-icon>{{ analysis.score >= 90 ? 'verified' : 'auto_awesome' }}</mat-icon>
                    <span>{{ analysis.score >= 90 ? 'Excellent Coverage' : 'Coverage Analysis' }}</span>
                  </div>
                  <span class="collapsed-summary">{{ analysis.summary }}</span>
                </div>
                <button mat-icon-button class="expand-btn" matTooltip="Show details">
                  <mat-icon>expand_more</mat-icon>
                </button>
              </div>

              <!-- Full View -->
              <ng-container *ngIf="!coverageCollapsed()">
                <div class="coverage-header">
                  <div class="score-ring" [ngClass]="getScoreColorClass(analysis.score)">
                    <svg viewBox="0 0 36 36" class="circular-chart">
                      <path class="circle-bg"
                        d="M18 2.0845
                           a 15.9155 15.9155 0 0 1 0 31.831
                           a 15.9155 15.9155 0 0 1 0 -31.831"
                      />
                      <path class="circle"
                        [attr.stroke-dasharray]="analysis.score + ', 100'"
                        d="M18 2.0845
                           a 15.9155 15.9155 0 0 1 0 31.831
                           a 15.9155 15.9155 0 0 1 0 -31.831"
                      />
                    </svg>
                    <span class="score-value">{{ analysis.score }}</span>
                  </div>
                  <div class="coverage-info">
                    <div class="coverage-title">
                      <mat-icon>auto_awesome</mat-icon>
                      Coverage Analysis
                      <button mat-icon-button class="refresh-btn" (click)="refreshCoverageAnalysis(); $event.stopPropagation()" 
                              [disabled]="coverageLoading()" matTooltip="Refresh analysis">
                        <mat-icon [class.spinning]="coverageLoading()">refresh</mat-icon>
                      </button>
                      <button mat-icon-button class="collapse-btn" 
                              (click)="toggleCoverageCollapsed(); $event.stopPropagation()" matTooltip="Collapse">
                        <mat-icon>unfold_less</mat-icon>
                      </button>
                    </div>
                    <p class="coverage-summary">{{ analysis.summary }}</p>
                    <div class="coverage-meta">
                      <span class="meta-item">
                        <mat-icon>business</mat-icon>
                        {{ analysis.industry }}
                      </span>
                      <span class="meta-item">
                        <mat-icon>checklist</mat-icon>
                        {{ analysis.existingCount }} inspection{{ analysis.existingCount !== 1 ? 's' : '' }}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Strengths & Gaps -->
                <div class="coverage-details" *ngIf="analysis.strengths?.length || analysis.gaps?.length">
                  <div class="detail-column" *ngIf="analysis.strengths?.length">
                    <div class="detail-header strengths">
                      <mat-icon>check_circle</mat-icon>
                      Strengths
                    </div>
                    <ul class="detail-list">
                      <li *ngFor="let strength of analysis.strengths">{{ strength }}</li>
                    </ul>
                  </div>
                  <div class="detail-column" *ngIf="analysis.gaps?.length">
                    <div class="detail-header gaps">
                      <mat-icon>warning</mat-icon>
                      Gaps
                    </div>
                    <ul class="detail-list">
                      <li *ngFor="let gap of analysis.gaps">{{ gap }}</li>
                    </ul>
                  </div>
                </div>

                <!-- Recommendations -->
                <div class="recommendations-section" *ngIf="analysis.recommendations?.length">
                  <div class="recommendations-header">
                    <mat-icon>lightbulb</mat-icon>
                    <span>Recommended Inspections</span>
                  </div>
                  <div class="recommendations-list">
                    <div class="recommendation-item" 
                         *ngFor="let rec of analysis.recommendations"
                         [ngClass]="getPriorityClass(rec.priority)"
                         (click)="useRecommendation(rec)">
                      <div class="rec-priority">
                        <mat-icon>{{ rec.priority === 'high' ? 'priority_high' : rec.priority === 'low' ? 'low_priority' : 'drag_handle' }}</mat-icon>
                      </div>
                      <div class="rec-content">
                        <span class="rec-name">{{ rec.name }}</span>
                        <span class="rec-description">{{ rec.description }}</span>
                        <span class="rec-reason">
                          <mat-icon>info</mat-icon>
                          {{ rec.reason }}
                        </span>
                      </div>
                      <div class="rec-meta">
                        <span class="rec-frequency">{{ rec.frequency }}</span>
                        <span class="rec-questions">{{ rec.questionCount }} questions</span>
                      </div>
                      <mat-icon class="rec-arrow">chevron_right</mat-icon>
                    </div>
                  </div>
                </div>

                <!-- Perfect Score State -->
                <div class="perfect-score" *ngIf="analysis.score >= 100 && !analysis.recommendations?.length">
                  <mat-icon>verified</mat-icon>
                  <span>Your inspection program is comprehensive. Great job maintaining compliance!</span>
                </div>
              </ng-container>
            </div>
          </ng-container>
        </section>

        <!-- No Industry Notice (only show if they have team members but no industry) -->
        <section class="no-industry-notice" *ngIf="hasTeamMembers() && !hasIndustry()">
          <mat-icon>lightbulb</mat-icon>
          <div class="notice-content">
            <strong>Set your industry to unlock coverage analysis</strong>
            <p>We need to know your industry to provide personalized inspection recommendations and ensure you're meeting the right compliance requirements.</p>
          </div>
          <button mat-stroked-button routerLink="/account/account">
            <mat-icon>settings</mat-icon>
            Set Industry
          </button>
        </section>

        <!-- Standard empty state - shown when no inspections AND cannot analyze coverage -->
        <div class="empty-state" *ngIf="allInspections.length === 0 && !canAnalyzeCoverage() && !autoBuildActive() && !autoBuildProgress()">
          <div class="empty-left">
            <mat-icon class="empty-icon">checklist</mat-icon>
            <div class="empty-content">
              <div class="empty-title">What are Self-Inspections?</div>
              <p>
                Self-inspections are recurring checklists that help you identify issues before they become incidents. 
                Regular workplace inspections are a cornerstone of any effective compliance program.
              </p>
              <p>
                Each inspection you create becomes a reusable template. Run it on a schedule—weekly, monthly, or quarterly—and 
                track your results over time. Document corrective actions and follow up until they're resolved.
              </p>
            </div>
          </div>
          <div class="empty-right">
            <div class="empty-cta-header">How it works</div>
            <ul class="empty-steps">
              <li><mat-icon>looks_one</mat-icon> <span><strong>Build an inspection</strong> using our smart builder or templates</span></li>
              <li><mat-icon>looks_two</mat-icon> <span><strong>Run it on a schedule</strong> to regularly check for issues</span></li>
              <li><mat-icon>looks_3</mat-icon> <span><strong>Track corrective actions</strong> and follow up until resolved</span></li>
            </ul>
          </div>
        </div>

        <section class="inspections-section" *ngIf="allInspections.length > 0">
          <div class="section-header">
            <div>
              <div class="section-title">All inspections</div>
              <div class="section-subtitle">Filter and sort your inspections by status.</div>
            </div>
            <div class="filter-bar">
              <button 
                mat-stroked-button 
                class="filter-chip" 
                [class.active]="(activeFilter$ | async) === 'all'"
                (click)="setFilter('all')">
                All
              </button>
              <button 
                mat-stroked-button 
                class="filter-chip" 
                [class.active]="(activeFilter$ | async) === 'inProgress'"
                (click)="setFilter('inProgress')">
                <mat-icon>resume</mat-icon>
                In Progress
              </button>
              <button 
                mat-stroked-button 
                class="filter-chip" 
                [class.active]="(activeFilter$ | async) === 'lastInspected'"
                (click)="setFilter('lastInspected')">
                <mat-icon>schedule</mat-icon>
                Last Inspected
              </button>
              <button 
                mat-stroked-button 
                class="filter-chip" 
                [class.active]="(activeFilter$ | async) === 'dueSoon'"
                (click)="setFilter('dueSoon')">
                <mat-icon>upcoming</mat-icon>
                Due Soon
              </button>
              <button 
                mat-stroked-button 
                class="filter-chip overdue-chip" 
                [class.active]="(activeFilter$ | async) === 'overdue'"
                (click)="setFilter('overdue')">
                <mat-icon>warning</mat-icon>
                Overdue
              </button>
            </div>
          </div>

          <ng-container *ngIf="filteredInspections$ | async as inspections">
            <div class="no-results" *ngIf="inspections.length === 0">
              <mat-icon>search_off</mat-icon>
              <div>No inspections match this filter.</div>
            </div>

            <div class="inspections-table" *ngIf="inspections.length > 0">
              <!-- Table Header -->
              <div class="table-header">
                <div class="col-status sortable" (click)="toggleSort('status')" [class.active]="(sort$ | async)?.column === 'status'">
                  Status
                  <mat-icon class="sort-icon" *ngIf="(sort$ | async)?.column === 'status'">
                    {{ (sort$ | async)?.direction === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                  </mat-icon>
                </div>
                <div class="col-name sortable" (click)="toggleSort('name')" [class.active]="(sort$ | async)?.column === 'name'">
                  Name
                  <mat-icon class="sort-icon" *ngIf="(sort$ | async)?.column === 'name'">
                    {{ (sort$ | async)?.direction === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                  </mat-icon>
                </div>
                <div class="col-last sortable" (click)="toggleSort('lastCompleted')" [class.active]="(sort$ | async)?.column === 'lastCompleted'">
                  Last Completed
                  <mat-icon class="sort-icon" *ngIf="(sort$ | async)?.column === 'lastCompleted'">
                    {{ (sort$ | async)?.direction === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                  </mat-icon>
                </div>
                <div class="col-next sortable" (click)="toggleSort('nextDue')" [class.active]="(sort$ | async)?.column === 'nextDue'">
                  Next Due
                  <mat-icon class="sort-icon" *ngIf="(sort$ | async)?.column === 'nextDue'">
                    {{ (sort$ | async)?.direction === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                  </mat-icon>
                </div>
                <div class="col-frequency sortable" (click)="toggleSort('frequency')" [class.active]="(sort$ | async)?.column === 'frequency'">
                  Frequency
                  <mat-icon class="sort-icon" *ngIf="(sort$ | async)?.column === 'frequency'">
                    {{ (sort$ | async)?.direction === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                  </mat-icon>
                </div>
                <div class="col-actions">Actions</div>
              </div>

              <!-- Table Rows (Card-like) -->
              <div 
                class="table-row" 
                *ngFor="let inspection of inspections; trackBy: trackByInspectionId" 
                [class.overdue]="inspection.status === 'overdue'" 
                [class.due-soon]="inspection.status === 'dueSoon'"
                (click)="selectSelfInspection(inspection)">
                
                <div class="col-status">
                  <span class="status-badge" [ngClass]="inspection.status">
                    {{ getStatusLabel(inspection.status) }}
                  </span>
                </div>

                <div class="col-name">
                  <span class="inspection-title">{{ inspection.title }}</span>
                </div>

                <div class="col-last">
                  <span *ngIf="inspection.lastCompletedAt">
                    {{ inspection.lastCompletedAt?.toDate ? (inspection.lastCompletedAt.toDate() | date: 'mediumDate') : (inspection.lastCompletedAt | date: 'mediumDate') }}
                  </span>
                  <span class="muted" *ngIf="!inspection.lastCompletedAt">Never</span>
                </div>

                <div class="col-next">
                  <ng-container *ngIf="inspection.nextDueDate">
                    <span [class.overdue-text]="inspection.status === 'overdue'" [class.due-soon-text]="inspection.status === 'dueSoon'">
                      {{ inspection.nextDueDate | date: 'mediumDate' }}
                    </span>
                    <span class="days-indicator" *ngIf="inspection.daysUntilDue !== undefined">
                      <ng-container *ngIf="inspection.daysUntilDue < 0">({{ -inspection.daysUntilDue }}d overdue)</ng-container>
                      <ng-container *ngIf="inspection.daysUntilDue === 0">(Today)</ng-container>
                      <ng-container *ngIf="inspection.daysUntilDue > 0">({{ inspection.daysUntilDue }}d)</ng-container>
                    </span>
                  </ng-container>
                  <span class="muted" *ngIf="!inspection.nextDueDate">—</span>
                </div>

                <div class="col-frequency">
                  <span *ngIf="inspection.inspectionExpiration">{{ inspection.inspectionExpiration }}</span>
                  <span class="muted" *ngIf="!inspection.inspectionExpiration">—</span>
                </div>

                <div class="col-actions">
                  <button 
                    mat-icon-button 
                    [color]="inspection.inProgressInspection ? 'primary' : 'accent'" 
                    class="start-action" 
                    [class.resume]="inspection.inProgressInspection"
                    [matTooltip]="inspection.inProgressInspection ? 'Resume in-progress inspection' : 'Start new inspection'" 
                    (click)="startInspection(inspection); $event.stopPropagation()">
                    <mat-icon>{{ inspection.inProgressInspection ? 'resume' : 'play_arrow' }}</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </ng-container>
        </section>
      </ng-container>

      <ng-template #loading>
        <div class="loading-state">
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
          <div class="loading-text">Loading inspections...</div>
        </div>
      </ng-template>
</div>
