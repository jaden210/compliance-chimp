<div class="page-layout">
<mat-toolbar>
  <img class="toolbar-logo" src="/assets/complianceChimpLogoLight.png" />
  <div class="toolbar-title">Dashboard</div>
  <div class="flex"></div>
</mat-toolbar>

<div class="page-content">
  <div class="content-wrapper">
    <!-- Welcome Tour Banner - Desktop -->
    <div class="welcome-tour-banner desktop-only" 
         *ngIf="accountService.aTeam?.id && welcomeService.shouldShowTourBanner()">
      <div class="banner-content">
        <img class="banner-chimp" src="/assets/chimpTop.png" alt="Chimp" />
        <div class="banner-text">
          <div class="banner-title">Welcome to Compliance Chimp!</div>
          <div class="banner-description">Let me show you around. I'll walk you through the key features.</div>
        </div>
        <button mat-flat-button class="banner-button tour-button" (click)="startTour()">
          Take the Tour
          <mat-icon>arrow_forward</mat-icon>
        </button>
        <button mat-icon-button class="dismiss-button" (click)="dismissTour()" aria-label="Dismiss tour banner">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>

    <!-- Welcome Tour Banner - Mobile -->
    <div class="welcome-tour-banner-mobile mobile-only" 
         *ngIf="accountService.aTeam?.id && welcomeService.shouldShowTourBanner()">
      <div class="mobile-tour-content">
        <img class="mobile-tour-chimp" src="/assets/chimpTop.png" alt="Chimp" />
        <div class="mobile-tour-text">
          <div class="mobile-tour-title">Welcome!</div>
          <div class="mobile-tour-desc">Let me show you around</div>
        </div>
        <button mat-flat-button class="mobile-tour-button" (click)="startTour()">
          Take Tour
          <mat-icon>arrow_forward</mat-icon>
        </button>
        <button mat-icon-button class="mobile-dismiss-button" (click)="dismissTour()" aria-label="Dismiss">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>

    <!-- Missing Contact Info Banner -->
    <app-contact-info-banner context="dashboard"></app-contact-info-banner>

    <!-- Trial / Subscription Banner - Desktop (hidden when tour banner is showing) -->
    <div class="subscription-banner desktop-only" 
         *ngIf="accountService.aTeam?.id && !accountService.aTeam?.stripeSubscriptionId && !welcomeService.shouldShowTourBanner()"
         [class.trial-expired]="accountService.isTrialExpired">
      <div class="banner-content">
        <div class="banner-icon">
          <mat-icon>{{ accountService.isTrialExpired ? 'hourglass_empty' : 'rocket_launch' }}</mat-icon>
        </div>
        <div class="banner-text">
          <ng-container *ngIf="accountService.isTrialExpired">
            <div class="banner-title">Your free trial has ended</div>
            <div class="banner-description">Subscribe now to continue creating content and managing your compliance program. You're currently in read-only mode.</div>
          </ng-container>
          <ng-container *ngIf="!accountService.isTrialExpired">
            <div class="banner-title">{{ accountService.trialDaysRemaining }} days left in your free trial</div>
            <div class="banner-description">You have full access to all features. Subscribe anytime to keep your compliance on track after your trial ends.</div>
          </ng-container>
        </div>
        <button mat-flat-button class="banner-button" (click)="startCheckout()">
          Subscribe Now — $99/mo
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>
    </div>

    <!-- Trial / Subscription Banner - Mobile (compact layout, hidden when tour banner is showing) -->
    <div class="subscription-banner-mobile mobile-only" 
         *ngIf="accountService.aTeam?.id && !accountService.aTeam?.stripeSubscriptionId && !welcomeService.shouldShowTourBanner()"
         [class.trial-expired]="accountService.isTrialExpired">
      <div class="mobile-banner-icon">
        <mat-icon>{{ accountService.isTrialExpired ? 'hourglass_empty' : 'rocket_launch' }}</mat-icon>
      </div>
      <div class="mobile-banner-action">
        <button mat-flat-button class="mobile-banner-button" (click)="startCheckout()">
          Subscribe — $99/mo
          <mat-icon>arrow_forward</mat-icon>
        </button>
        <div class="mobile-banner-days" *ngIf="!accountService.isTrialExpired">
          {{ accountService.trialDaysRemaining }} days left
        </div>
        <div class="mobile-banner-days expired" *ngIf="accountService.isTrialExpired">
          Trial ended
        </div>
      </div>
    </div>
    <!-- Welcome Section -->
    <section class="dashboard-section">
      <div class="dashboard-header">
        <div class="team-identity">
          <img 
            *ngIf="accountService.aTeam?.logoUrl" 
            class="team-logo" 
            [src]="accountService.aTeam.logoUrl" 
            [alt]="accountService.aTeam.name + ' logo'" />
          <div class="team-info">
            <h1 class="team-name">{{ accountService.aTeam?.name || 'Your Team' }}</h1>
            <p class="welcome-text">Welcome back<span *ngIf="accountService.user?.name">, {{ accountService.user.name.split(' ')[0] }}</span>! Here's your compliance overview.</p>
          </div>
        </div>
      </div>

      <!-- Metrics Grid -->
      <div class="metrics-grid">
        <!-- Team Members -->
        <div class="metric-card desktop-clickable mobile-team-card" routerLink="/account/team">
          <div class="metric-icon info">
            <mat-icon>groups</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-label">Team Members</div>
            <div class="metric-value">{{ users?.length || 0 }} total</div>
          </div>
          <mat-icon class="metric-action desktop-only">arrow_forward</mat-icon>
        </div>

        <!-- Self Inspections -->
        <div class="metric-card desktop-clickable" routerLink="/account/self-inspections">
          <div class="metric-icon" [ngClass]="{
            'warning': selfInspection.overdue > 0 || selfInspection.dueSoon > 0,
            'success': selfInspection.total > 0 && selfInspection.overdue === 0 && selfInspection.dueSoon === 0,
            'info': selfInspection.total === 0
          }">
            <mat-icon>fact_check</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-label">Self Inspections</div>
            <div class="metric-value" *ngIf="selfInspection.overdue > 0 || selfInspection.dueSoon > 0">
              {{ selfInspection.overdue + selfInspection.dueSoon }} need attention
            </div>
            <div class="metric-value" *ngIf="selfInspection.overdue === 0 && selfInspection.dueSoon === 0 && selfInspection.total > 0">
              All on track
            </div>
            <div class="metric-value" *ngIf="selfInspection.total === 0">
              None yet
            </div>
          </div>
          <mat-icon class="metric-action desktop-only">arrow_forward</mat-icon>
        </div>

        <!-- Incident Reports -->
        <div class="metric-card desktop-clickable" routerLink="/account/incident-reports">
          <div class="metric-icon error">
            <mat-icon>report_problem</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-label">Incident Reports</div>
            <div class="metric-value">{{ incidentReportsCount }}</div>
          </div>
          <mat-icon class="metric-action desktop-only">arrow_forward</mat-icon>
        </div>

        <!-- Team Files -->
        <div class="metric-card desktop-clickable" routerLink="/account/files">
          <div class="metric-icon primary">
            <mat-icon>folder_open</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-label">Team Files</div>
            <div class="metric-value">{{ teamFilesCount }} documents</div>
          </div>
          <mat-icon class="metric-action desktop-only">arrow_forward</mat-icon>
        </div>
      </div>
    </section>

    <!-- Mobile Quick Links Section -->
    <section class="mobile-quick-links mobile-only">
      <div class="mobile-link-card" routerLink="/account/team">
        <div class="mobile-link-icon">
          <mat-icon>groups</mat-icon>
        </div>
        <div class="mobile-link-content">
          <div class="mobile-link-title">Team</div>
          <div class="mobile-link-desc">Manage team members, add contacts, assign tags</div>
        </div>
        <mat-icon class="mobile-link-arrow">arrow_forward</mat-icon>
      </div>
      <div class="mobile-link-card" routerLink="/account/account">
        <div class="mobile-link-icon">
          <mat-icon>settings</mat-icon>
        </div>
        <div class="mobile-link-content">
          <div class="mobile-link-title">Account Settings</div>
          <div class="mobile-link-desc">Manage your business info and billing</div>
        </div>
        <mat-icon class="mobile-link-arrow">arrow_forward</mat-icon>
      </div>
    </section>

    <!-- Quick Actions Section -->
    <section class="quick-actions-section desktop-only">
      <div class="section-header">
        <mat-icon>flash_on</mat-icon>
        <h2>Quick Actions</h2>
      </div>

      <!-- ChimpChat hero - full width, primary entry point -->
      <div class="chimp-chat-hero" (click)="accountService.requestOpenChimpChat()">
        <div class="chimp-chat-hero-icon">
          <img src="/assets/chimpFace.png" alt="" class="chimp-chat-hero-img" />
        </div>
        <div class="chimp-chat-hero-text">
          <h3 class="chimp-chat-hero-title">Chimp<span class="chimp-chat-hero-accent">Chat</span> — Start here and I'll help you get it done.</h3>
          <p class="chimp-chat-hero-desc">Run training, complete inspections, log incidents, manage your team. Whatever you're here to do.</p>
        </div>
        <div class="chimp-chat-hero-action">
          <span class="chimp-chat-hero-action-label">Let's Go</span>
          <mat-icon class="chimp-chat-hero-action-icon">arrow_forward</mat-icon>
        </div>
      </div>

      <div class="actions-grid">
        <div class="action-card" routerLink="/account/team">
          <div class="action-icon">
            <mat-icon>person_add</mat-icon>
          </div>
          <div class="action-text">
            <div class="action-title">Add Team Member</div>
            <div class="action-desc">Invite someone to your team</div>
          </div>
        </div>

        <div class="action-card" routerLink="/account/training">
          <div class="action-icon">
            <mat-icon>play_circle</mat-icon>
          </div>
          <div class="action-text">
            <div class="action-title">Start Training</div>
            <div class="action-desc">Begin a training session</div>
          </div>
        </div>

        <div class="action-card" routerLink="/account/self-inspections">
          <div class="action-icon">
            <mat-icon>checklist</mat-icon>
          </div>
          <div class="action-text">
            <div class="action-title">Run Inspection</div>
            <div class="action-desc">Complete a self-inspection</div>
          </div>
        </div>

        <div class="action-card" routerLink="/account/incident-reports">
          <div class="action-icon">
            <mat-icon>edit_note</mat-icon>
          </div>
          <div class="action-text">
            <div class="action-title">Report Incident</div>
            <div class="action-desc">Log a safety incident</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Activity Overview Section -->
    <section class="activity-section desktop-only">
      <div class="section-header">
        <mat-icon>assessment</mat-icon>
        <h2>Activity Overview</h2>
      </div>

      <div class="activity-grid">
        <!-- Inspection Health -->
        <div class="activity-card" routerLink="/account/self-inspections">
          <div class="activity-card-header">
            <div class="activity-card-title">
              <mat-icon>fact_check</mat-icon>
              <span>Inspection Health</span>
            </div>
            <span class="activity-card-total" *ngIf="selfInspection.total > 0">{{ selfInspection.total }} total</span>
          </div>

          <!-- Stacked bar chart -->
          <div class="stacked-bar-container" *ngIf="selfInspection.total > 0">
            <div class="stacked-bar">
              <div class="bar-segment overdue"
                   *ngIf="selfInspection.overdue > 0"
                   [style.width.%]="(selfInspection.overdue / selfInspection.total) * 100">
              </div>
              <div class="bar-segment due-soon"
                   *ngIf="selfInspection.dueSoon > 0"
                   [style.width.%]="(selfInspection.dueSoon / selfInspection.total) * 100">
              </div>
              <div class="bar-segment on-track"
                   *ngIf="selfInspection.onTrack > 0"
                   [style.width.%]="(selfInspection.onTrack / selfInspection.total) * 100">
              </div>
              <div class="bar-segment never-run"
                   *ngIf="selfInspection.neverRun > 0"
                   [style.width.%]="(selfInspection.neverRun / selfInspection.total) * 100">
              </div>
            </div>

            <div class="bar-legend">
              <div class="legend-item" *ngIf="selfInspection.overdue > 0">
                <span class="legend-dot overdue"></span>
                <span class="legend-count">{{ selfInspection.overdue }}</span>
                <span class="legend-label">Overdue</span>
              </div>
              <div class="legend-item" *ngIf="selfInspection.dueSoon > 0">
                <span class="legend-dot due-soon"></span>
                <span class="legend-count">{{ selfInspection.dueSoon }}</span>
                <span class="legend-label">Due Soon</span>
              </div>
              <div class="legend-item" *ngIf="selfInspection.onTrack > 0">
                <span class="legend-dot on-track"></span>
                <span class="legend-count">{{ selfInspection.onTrack }}</span>
                <span class="legend-label">On Track</span>
              </div>
              <div class="legend-item" *ngIf="selfInspection.neverRun > 0">
                <span class="legend-dot never-run"></span>
                <span class="legend-count">{{ selfInspection.neverRun }}</span>
                <span class="legend-label">Never Run</span>
              </div>
            </div>
          </div>

          <!-- Empty state -->
          <div class="activity-empty" *ngIf="selfInspection.total === 0">
            <mat-icon>add_task</mat-icon>
            <span>No inspections set up yet</span>
          </div>
        </div>

        <!-- Training Health -->
        <div class="activity-card" routerLink="/account/training">
          <div class="activity-card-header">
            <div class="activity-card-title">
              <mat-icon>school</mat-icon>
              <span>Training Health</span>
            </div>
            <span class="activity-card-total" *ngIf="trainingHealth.total > 0">{{ trainingHealth.total }} total</span>
          </div>

          <!-- Stacked bar chart -->
          <div class="stacked-bar-container" *ngIf="trainingHealth.total > 0">
            <div class="stacked-bar">
              <div class="bar-segment on-track"
                   *ngIf="trainingHealth.compliant > 0"
                   [style.width.%]="(trainingHealth.compliant / trainingHealth.total) * 100">
              </div>
              <div class="bar-segment due-soon"
                   *ngIf="trainingHealth.inProgress > 0"
                   [style.width.%]="(trainingHealth.inProgress / trainingHealth.total) * 100">
              </div>
              <div class="bar-segment never-run"
                   *ngIf="trainingHealth.notStarted > 0"
                   [style.width.%]="(trainingHealth.notStarted / trainingHealth.total) * 100">
              </div>
            </div>

            <div class="bar-legend">
              <div class="legend-item" *ngIf="trainingHealth.compliant > 0">
                <span class="legend-dot on-track"></span>
                <span class="legend-count">{{ trainingHealth.compliant }}</span>
                <span class="legend-label">Compliant</span>
              </div>
              <div class="legend-item" *ngIf="trainingHealth.inProgress > 0">
                <span class="legend-dot due-soon"></span>
                <span class="legend-count">{{ trainingHealth.inProgress }}</span>
                <span class="legend-label">In Progress</span>
              </div>
              <div class="legend-item" *ngIf="trainingHealth.notStarted > 0">
                <span class="legend-dot never-run"></span>
                <span class="legend-count">{{ trainingHealth.notStarted }}</span>
                <span class="legend-label">Not Started</span>
              </div>
            </div>
          </div>

          <!-- Empty state -->
          <div class="activity-empty" *ngIf="trainingHealth.total === 0 && !hasTrainingContent">
            <mat-icon>cast_for_education</mat-icon>
            <span>No training content yet</span>
          </div>
          <div class="activity-empty" *ngIf="trainingHealth.total === 0 && hasTrainingContent">
            <mat-icon>schedule</mat-icon>
            <span>Trainings scheduled — waiting on first completions</span>
          </div>
        </div>
      </div>

      <!-- Activity Timeline Chart -->
      <div class="activity-chart-card" *ngIf="hasEvents">
        <div class="activity-chart-header">
          <div class="activity-card-title">
            <mat-icon>timeline</mat-icon>
            <span>Activity — Last 30 Days</span>
          </div>
          <span class="activity-card-total">{{ totalEventsCount }} events</span>
        </div>
        <div class="activity-chart-wrap">
          <canvas baseChart
                  [type]="activityChartConfig.type"
                  [data]="activityChartConfig.data"
                  [options]="activityChartConfig.options">
          </canvas>
        </div>
      </div>
    </section>
  </div>
</div>
</div>
