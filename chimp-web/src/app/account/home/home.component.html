<div class="page-layout">
<mat-toolbar>
  <img class="toolbar-logo" src="/assets/complianceChimpLogoLight.png" />
  <div class="toolbar-title">Dashboard</div>
  <div class="flex"></div>
</mat-toolbar>

<div class="page-content">
  <div class="content-wrapper">
    <!-- Welcome Tour Banner - Desktop -->
    <div class="welcome-tour-banner desktop-only" 
         *ngIf="accountService.aTeam?.id && welcomeService.shouldShowTourBanner()">
      <div class="banner-content">
        <img class="banner-chimp" src="/assets/chimpTop.png" alt="Chimp" />
        <div class="banner-text">
          <div class="banner-title">Welcome to Compliance Chimp!</div>
          <div class="banner-description">Let me show you around. I'll walk you through the key features.</div>
        </div>
        <button mat-flat-button class="banner-button tour-button" (click)="startTour()">
          Take the Tour
          <mat-icon>arrow_forward</mat-icon>
        </button>
        <button mat-icon-button class="dismiss-button" (click)="dismissTour()" aria-label="Dismiss tour banner">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>

    <!-- Welcome Tour Banner - Mobile -->
    <div class="welcome-tour-banner-mobile mobile-only" 
         *ngIf="accountService.aTeam?.id && welcomeService.shouldShowTourBanner()">
      <div class="mobile-tour-content">
        <img class="mobile-tour-chimp" src="/assets/chimpTop.png" alt="Chimp" />
        <div class="mobile-tour-text">
          <div class="mobile-tour-title">Welcome!</div>
          <div class="mobile-tour-desc">Let me show you around</div>
        </div>
        <button mat-flat-button class="mobile-tour-button" (click)="startTour()">
          Take Tour
          <mat-icon>arrow_forward</mat-icon>
        </button>
        <button mat-icon-button class="mobile-dismiss-button" (click)="dismissTour()" aria-label="Dismiss">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>

    <!-- Trial / Subscription Banner - Desktop (hidden when tour banner is showing) -->
    <div class="subscription-banner desktop-only" 
         *ngIf="accountService.aTeam?.id && !accountService.aTeam?.stripeSubscriptionId && !welcomeService.shouldShowTourBanner()"
         [class.trial-expired]="accountService.isTrialExpired">
      <div class="banner-content">
        <div class="banner-icon">
          <mat-icon>{{ accountService.isTrialExpired ? 'hourglass_empty' : 'rocket_launch' }}</mat-icon>
        </div>
        <div class="banner-text">
          <ng-container *ngIf="accountService.isTrialExpired">
            <div class="banner-title">Your free trial has ended</div>
            <div class="banner-description">Subscribe now to continue creating content and managing your compliance program. You're currently in read-only mode.</div>
          </ng-container>
          <ng-container *ngIf="!accountService.isTrialExpired">
            <div class="banner-title">{{ accountService.trialDaysRemaining }} days left in your free trial</div>
            <div class="banner-description">You have full access to all features. Subscribe anytime to keep your compliance on track after your trial ends.</div>
          </ng-container>
        </div>
        <button mat-flat-button class="banner-button" (click)="startCheckout()">
          Subscribe Now — $99/mo
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>
    </div>

    <!-- Trial / Subscription Banner - Mobile (compact layout, hidden when tour banner is showing) -->
    <div class="subscription-banner-mobile mobile-only" 
         *ngIf="accountService.aTeam?.id && !accountService.aTeam?.stripeSubscriptionId && !welcomeService.shouldShowTourBanner()"
         [class.trial-expired]="accountService.isTrialExpired">
      <div class="mobile-banner-icon">
        <mat-icon>{{ accountService.isTrialExpired ? 'hourglass_empty' : 'rocket_launch' }}</mat-icon>
      </div>
      <div class="mobile-banner-action">
        <button mat-flat-button class="mobile-banner-button" (click)="startCheckout()">
          Subscribe — $99/mo
          <mat-icon>arrow_forward</mat-icon>
        </button>
        <div class="mobile-banner-days" *ngIf="!accountService.isTrialExpired">
          {{ accountService.trialDaysRemaining }} days left
        </div>
        <div class="mobile-banner-days expired" *ngIf="accountService.isTrialExpired">
          Trial ended
        </div>
      </div>
    </div>
    <!-- Welcome Section -->
    <section class="dashboard-section">
      <div class="dashboard-header">
        <div class="team-identity">
          <img 
            *ngIf="accountService.aTeam?.logoUrl" 
            class="team-logo" 
            [src]="accountService.aTeam.logoUrl" 
            [alt]="accountService.aTeam.name + ' logo'" />
          <div class="team-info">
            <h1 class="team-name">{{ accountService.aTeam?.name || 'Your Team' }}</h1>
            <p class="welcome-text">Welcome back<span *ngIf="accountService.user?.name">, {{ accountService.user.name.split(' ')[0] }}</span>! Here's your compliance overview.</p>
          </div>
        </div>
      </div>

      <!-- Metrics Grid -->
      <div class="metrics-grid">
        <!-- Training Complete -->
        <div class="metric-card desktop-clickable" routerLink="/account/training">
          <div class="metric-icon success">
            <mat-icon>school</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-label">Training Complete</div>
            <div class="metric-value">{{ trainingComplete || 0 }}%</div>
          </div>
          <mat-icon class="metric-action desktop-only">arrow_forward</mat-icon>
        </div>

        <!-- Members Needing Training -->
        <div class="metric-card desktop-clickable" routerLink="/account/training">
          <div class="metric-icon warning">
            <mat-icon>pending_actions</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-label">Need Training</div>
            <div class="metric-value">{{ needsTraining?.length || 0 }} members</div>
          </div>
          <mat-icon class="metric-action desktop-only">arrow_forward</mat-icon>
        </div>

        <!-- Team Members -->
        <div class="metric-card desktop-clickable" routerLink="/account/team">
          <div class="metric-icon info">
            <mat-icon>groups</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-label">Team Members</div>
            <div class="metric-value">{{ users?.length || 0 }} total</div>
          </div>
          <mat-icon class="metric-action desktop-only">arrow_forward</mat-icon>
        </div>

        <!-- Incident Reports -->
        <div class="metric-card desktop-clickable" routerLink="/account/incident-reports">
          <div class="metric-icon error">
            <mat-icon>report_problem</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-label">Incident Reports</div>
            <div class="metric-value">{{ incidentReportsCount }}</div>
          </div>
          <mat-icon class="metric-action desktop-only">arrow_forward</mat-icon>
        </div>
      </div>
    </section>

    <!-- Mobile Quick Links Section -->
    <section class="mobile-quick-links mobile-only">
      <div class="mobile-link-card" routerLink="/account/account">
        <div class="mobile-link-icon">
          <mat-icon>settings</mat-icon>
        </div>
        <div class="mobile-link-content">
          <div class="mobile-link-title">Account Settings</div>
          <div class="mobile-link-desc">Manage your business info and billing</div>
        </div>
        <mat-icon class="mobile-link-arrow">arrow_forward</mat-icon>
      </div>
    </section>

    <!-- Mobile Desktop Notice -->
    <section class="mobile-desktop-notice mobile-only">
      <div class="notice-icon">
        <mat-icon>laptop_mac</mat-icon>
      </div>
      <div class="notice-content">
        <h3>Full Features on Desktop</h3>
        <p>For the complete experience including team management, training delivery, inspections, and detailed reports, visit Compliance Chimp on your computer.</p>
      </div>
    </section>

    <!-- Quick Actions Section -->
    <section class="quick-actions-section desktop-only">
      <div class="section-header">
        <mat-icon>flash_on</mat-icon>
        <h2>Quick Actions</h2>
      </div>

      <!-- ChimpChat hero - full width, primary entry point -->
      <div class="chimp-chat-hero" (click)="accountService.requestOpenChimpChat()">
        <div class="chimp-chat-hero-icon">
          <img src="/assets/chimpFace.png" alt="" class="chimp-chat-hero-img" />
        </div>
        <div class="chimp-chat-hero-text">
          <h3 class="chimp-chat-hero-title">Chimp<span class="chimp-chat-hero-accent">Chat</span> — Start here and I'll help you get it done.</h3>
          <p class="chimp-chat-hero-desc">Run training, complete inspections, log incidents, manage your team. Whatever you're here to do.</p>
        </div>
      </div>

      <div class="actions-grid">
        <div class="action-card" routerLink="/account/team">
          <div class="action-icon">
            <mat-icon>person_add</mat-icon>
          </div>
          <div class="action-text">
            <div class="action-title">Add Team Member</div>
            <div class="action-desc">Invite someone to your team</div>
          </div>
        </div>

        <div class="action-card" routerLink="/account/training">
          <div class="action-icon">
            <mat-icon>play_circle</mat-icon>
          </div>
          <div class="action-text">
            <div class="action-title">Start Training</div>
            <div class="action-desc">Begin a training session</div>
          </div>
        </div>

        <div class="action-card" routerLink="/account/self-inspections">
          <div class="action-icon">
            <mat-icon>checklist</mat-icon>
          </div>
          <div class="action-text">
            <div class="action-title">Run Inspection</div>
            <div class="action-desc">Complete a self-inspection</div>
          </div>
        </div>

        <div class="action-card" routerLink="/account/incident-reports">
          <div class="action-icon">
            <mat-icon>edit_note</mat-icon>
          </div>
          <div class="action-text">
            <div class="action-title">Report Incident</div>
            <div class="action-desc">Log a safety incident</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Status Overview Section -->
    <section class="status-section desktop-only">
      <div class="section-header">
        <mat-icon>assessment</mat-icon>
        <h2>Compliance Status</h2>
      </div>

      <div class="status-grid">
        <!-- Self Inspections -->
        <div class="status-card" routerLink="/account/self-inspections">
          <div class="status-header">
            <mat-icon>fact_check</mat-icon>
            <span>Self Inspections</span>
          </div>
          <div class="status-stats">
            <div class="stat">
              <span class="stat-value success">{{ selfInspection?.current || 0 }}</span>
              <span class="stat-label">Current</span>
            </div>
            <div class="stat">
              <span class="stat-value" [class.warning]="selfInspection?.expired > 0">{{ selfInspection?.expired || 0 }}</span>
              <span class="stat-label">Expired</span>
            </div>
          </div>
        </div>

        <!-- Survey Responses -->
        <div class="status-card" routerLink="/account/training">
          <div class="status-header">
            <mat-icon>poll</mat-icon>
            <span>Survey Responses</span>
          </div>
          <div class="status-stats">
            <div class="stat">
              <span class="stat-value">{{ surveyResponsesCount }}</span>
              <span class="stat-label">Total Responses</span>
            </div>
          </div>
        </div>

        <!-- Trainings Given -->
        <div class="status-card" routerLink="/account/training">
          <div class="status-header">
            <mat-icon>cast_for_education</mat-icon>
            <span>Trainings Given</span>
          </div>
          <div class="status-stats">
            <div class="stat">
              <span class="stat-value">{{ surveysGivenCount }}</span>
              <span class="stat-label">Sessions</span>
            </div>
          </div>
        </div>

        <!-- Team Files -->
        <div class="status-card" routerLink="/account/files">
          <div class="status-header">
            <mat-icon>folder_open</mat-icon>
            <span>Team Files</span>
          </div>
          <div class="status-stats">
            <div class="stat">
              <span class="stat-value">{{ (files | async)?.length || 0 }}</span>
              <span class="stat-label">Documents</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>
</div>
