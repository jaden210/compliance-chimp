<div class="step-container">
  <div class="step-card">
    <div class="step-header">
      <div class="step-indicator">Step 2 of 4</div>
      <h1>{{ accountAlreadyCreated ? 'Signed in' : (challengeService.isDryRun ? 'Sign in with dev account' : 'Create your account') }}</h1>
      <p class="step-subtitle">You're setting up {{ challengeService.businessName }}</p>
    </div>

    <!-- Account Already Created / Signed In View -->
    <div class="account-created-section" *ngIf="accountAlreadyCreated">
      <div class="success-banner">
        <mat-icon>check_circle</mat-icon>
        <div class="success-content">
          <strong>{{ challengeService.isDryRun ? 'Signed in!' : 'Your account is ready!' }}</strong>
          <p>Signed in as <strong>{{ challengeService.email }}</strong></p>
        </div>
      </div>
    </div>

    <!-- Create Account / Sign In Form -->
    <ng-container *ngIf="!accountAlreadyCreated">
      <div class="error-message" *ngIf="errorMessage">
        <mat-icon>error</mat-icon>
        {{ errorMessage }}
      </div>

      <div class="form-section">
        <ng-container *ngIf="!challengeService.isDryRun">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Your Name</mat-label>
            <input
              matInput
              [(ngModel)]="name"
              placeholder="John Smith"
              [disabled]="isLoading"
            />
          </mat-form-field>
        </ng-container>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Email</mat-label>
          <input
            matInput
            type="email"
            [(ngModel)]="email"
            [placeholder]="challengeService.isDryRun ? 'dev@example.com' : 'john@example.com'"
            [disabled]="isLoading"
          />
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Password</mat-label>
          <input
            matInput
            [type]="hidePassword ? 'password' : 'text'"
            [(ngModel)]="password"
            placeholder="Minimum 6 characters"
            [disabled]="isLoading"
            (keyup.enter)="createAccount()"
          />
          <button mat-icon-button matSuffix (click)="hidePassword = !hidePassword" type="button" tabindex="-1">
            <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
        </mat-form-field>

        <ng-container *ngIf="!challengeService.isDryRun">
          <div class="terms-checkbox">
            <mat-checkbox [(ngModel)]="agreedToTerms" [disabled]="isLoading">
              I agree to the 
              <a routerLink="/terms-of-service" target="_blank">Terms</a> &
              <a routerLink="/privacy-policy" target="_blank">Privacy Policy</a>
            </mat-checkbox>
          </div>
        </ng-container>
      </div>
    </ng-container>

    <div class="step-actions">
      <button
        mat-button
        class="back-btn"
        (click)="goBack()"
        [disabled]="isLoading"
      >
        <mat-icon>arrow_back</mat-icon>
        Back
      </button>
      <button
        *ngIf="!accountAlreadyCreated"
        mat-flat-button
        color="accent"
        class="next-btn"
        [disabled]="!isValid() || isLoading"
        (click)="createAccount()"
      >
        {{ challengeService.isDryRun ? 'Sign in' : 'Next' }}
        <mat-icon iconPositionEnd>arrow_forward</mat-icon>
      </button>
      <button
        *ngIf="accountAlreadyCreated"
        mat-flat-button
        color="accent"
        class="next-btn"
        (click)="continueToNextStep()"
      >
        Continue
        <mat-icon iconPositionEnd>arrow_forward</mat-icon>
      </button>
    </div>
  </div>
</div>
