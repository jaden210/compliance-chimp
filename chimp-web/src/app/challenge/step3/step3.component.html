<div class="step-container">
  <div class="step-card">
    <div class="step-header">
      <div class="step-indicator">Step 3 of 4</div>
      <h1>Build your team</h1>
      <p class="step-subtitle">Your team is the foundation of your entire compliance program.</p>
    </div>

    <!-- Info Banner -->
    <div class="info-banner important">
      <mat-icon class="banner-icon">auto_awesome</mat-icon>
      <div class="info-text">
        <strong class="desktop-only">This is the most important step</strong>
        <strong class="mobile-only"><mat-icon class="inline-icon">auto_awesome</mat-icon> Job titles help us build your:</strong>
        <p class="desktop-only">Based on your team's job titles, we'll automatically generate:</p>
        <ul class="info-list">
          <li><mat-icon>school</mat-icon> Role-specific safety trainings</li>
          <li><mat-icon>checklist</mat-icon> Customized self-inspections</li>
          <li><mat-icon>assignment</mat-icon> Targeted compliance surveys</li>
        </ul>
        <div class="info-emphasis">
          <p>The Chimp will automatically assign tags based on job titles, grouping similar roles together for consistent training assignments.</p>
          <button mat-stroked-button class="learn-more-btn" (click)="openTagsHelpDialog()">
            <mat-icon>help_outline</mat-icon>
            Learn more about tags
          </button>
        </div>
        <p class="info-hint desktop-only">The more accurate your job titles, the more relevant your content will be.</p>
      </div>
    </div>

    <!-- CSV Import Section (desktop only) -->
    <div class="csv-import-section desktop-only">
      <div class="csv-card">
        <div class="csv-icon">
          <mat-icon>upload_file</mat-icon>
        </div>
        <div class="csv-content">
          <h3>Import from CSV</h3>
          <p>Have a team list? Download our template and upload to add everyone at once.</p>
        </div>
        <div class="csv-actions">
          <button 
            mat-stroked-button 
            color="primary"
            (click)="downloadCsvTemplate()"
          >
            <mat-icon>download</mat-icon>
            Template
          </button>
          <button 
            mat-stroked-button 
            color="primary"
            (click)="triggerCsvUpload()"
            [disabled]="csvUploading"
          >
            <mat-spinner *ngIf="csvUploading" diameter="20"></mat-spinner>
            <mat-icon *ngIf="!csvUploading">upload</mat-icon>
            <span *ngIf="!csvUploading">Upload</span>
          </button>
        </div>
      </div>

      <!-- Hidden file input -->
      <input 
        type="file" 
        #csvFileInput 
        accept=".csv" 
        style="display: none;" 
        (change)="onCsvFileSelected($event)">

      <!-- CSV Error/Success Messages -->
      <div class="csv-message error" *ngIf="csvError">
        <mat-icon>error</mat-icon>
        <span>{{ csvError }}</span>
        <button mat-icon-button (click)="clearCsvResult()"><mat-icon>close</mat-icon></button>
      </div>
      <div class="csv-message success" *ngIf="csvImportResult?.success">
        <mat-icon>check_circle</mat-icon>
        <span>Successfully imported {{ csvImportResult.added }} team member{{ csvImportResult.added === 1 ? '' : 's' }}!</span>
        <button mat-icon-button (click)="clearCsvResult()"><mat-icon>close</mat-icon></button>
      </div>
    </div>

    <div class="divider desktop-only">
      <span>or add manually</span>
    </div>

    <!-- Desktop Members Table -->
    <div class="members-table desktop-only">
      <div class="table-header">
        <div class="col-name">Name</div>
        <div class="col-job">Job Title</div>
        <div class="col-tags">Tags <mat-icon class="help-icon" (click)="openTagsHelpDialog()">help_outline</mat-icon></div>
        <div class="col-actions"></div>
      </div>

      <!-- Existing Members -->
      @for (member of teamMembers; track member.id) {
        <div class="table-row" 
             [class.has-issues]="!member.jobTitle?.trim()">
          <div class="col-name">
            <input 
              class="inline-input"
              [ngModel]="member.name"
              (ngModelChange)="updateMemberField(member, 'name', $event)"
              (blur)="onMemberFieldBlur(member, 'name')"
              placeholder="Name (required)"
            />
          </div>
          <div class="col-job">
            <input 
              class="inline-input"
              [ngModel]="member.jobTitle"
              (ngModelChange)="member.jobTitle=$event; updateMemberField(member, 'jobTitle', $event)"
              (blur)="onMemberFieldBlur(member, 'jobTitle')"
              placeholder="Job title (required)"
            />
          </div>
          <div class="col-tags" [class.tagging]="isMemberBeingTagged(member.id)">
            <!-- Show spinner when this member is being tagged -->
            <div class="tagging-indicator" *ngIf="isMemberBeingTagged(member.id)">
              <mat-spinner diameter="16"></mat-spinner>
              <span>Generating...</span>
            </div>
            <!-- Show tag input -->
            <app-tag-input
              *ngIf="!isMemberBeingTagged(member.id)"
              [tags]="member.tags || []"
              [allTags]="allTags"
              (tagsChange)="saveMemberTags(member, $event)"
              [compact]="true"
              placeholder="Tags...">
            </app-tag-input>
          </div>
          <div class="col-actions">
            <button 
              mat-icon-button 
              class="remove-btn"
              (click)="removeMember(member)"
              matTooltip="Remove"
              *ngIf="!isOwnerMember(member)"
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>
      }

      <!-- Add New Row -->
      <div class="table-row add-row">
        <div class="col-name">
          <input 
            #nameInput
            class="inline-input"
            [(ngModel)]="newMember.name"
            (keydown.enter)="addMember()"
            [placeholder]="teamMembers.length === 0 ? 'Enter name' : '+ Add another'"
          />
        </div>
        <div class="col-job">
          <input 
            class="inline-input"
            [(ngModel)]="newMember.jobTitle"
            (ngModelChange)="onNewMemberJobTitleChange()"
            (keydown.enter)="addMember()"
            (blur)="onNewMemberJobTitleBlur()"
            placeholder="Job title"
          />
          <mat-spinner *ngIf="isTagging" diameter="16" class="tagging-spinner"></mat-spinner>
        </div>
        <div class="col-tags">
          <app-tag-input
            [tags]="newMember.tags"
            [allTags]="allTags"
            (tagsChange)="newMember.tags = $event"
            (enterSubmit)="addMember()"
            [compact]="true"
            placeholder="Tags...">
          </app-tag-input>
        </div>
        <div class="col-actions">
          <button 
            mat-mini-fab 
            (click)="addMember()"
            [disabled]="!canAddMember()"
            class="add-btn"
            matTooltip="Add member"
            tabindex="-1"
          >
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile Member Adder -->
    <div class="mobile-member-adder mobile-only">
      <div class="divider">
        <span>Add your team</span>
      </div>
      <!-- Add Form -->
      <div class="mobile-add-form">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Name</mat-label>
          <input
            matInput
            #mobileNameInput
            [(ngModel)]="newMember.name"
            (keydown.enter)="mobileJobTitleInput.focus()"
            placeholder="e.g. John Smith"
          />
        </mat-form-field>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Job Title</mat-label>
          <input
            matInput
            #mobileJobTitleInput
            [(ngModel)]="newMember.jobTitle"
            (ngModelChange)="onNewMemberJobTitleChange()"
            (keydown.enter)="addMember()"
            (blur)="onNewMemberJobTitleBlur()"
            placeholder="e.g. Warehouse Associate"
          />
        </mat-form-field>
        <button
          mat-fab
          class="mobile-add-btn"
          (click)="addMember()"
          [disabled]="!canAddMember()"
          extended
        >
          <mat-icon>person_add</mat-icon>
          Add Member
        </button>
      </div>

      <!-- Member Count -->
      <div class="member-count" *ngIf="teamMembers.length > 0">
        <mat-icon>group</mat-icon>
        <span>{{ teamMembers.length }} team member{{ teamMembers.length === 1 ? '' : 's' }} added</span>
        <button
          mat-icon-button
          class="toggle-tags-btn"
          (click)="toggleAllMobileTags()"
        >
          <mat-icon>{{ mobileShowAllTags ? 'badge' : 'sell' }}</mat-icon>
        </button>
      </div>
      <div class="member-count empty" *ngIf="teamMembers.length === 0">
        <span>No team members yet â€” add your first one above</span>
      </div>

      <!-- Member Cards -->
      <div class="mobile-member-list">
        @for (member of teamMembers; track member.id) {
          <div class="mobile-member-card" [class.has-issues]="!member.jobTitle?.trim()" [class.tags-expanded]="mobileShowAllTags">
            <div class="member-info">
              <div class="member-name-row">
                <span class="member-name">{{ member.name }}</span>
                <button
                  mat-icon-button
                  class="remove-btn"
                  (click)="removeMember(member)"
                  *ngIf="!isOwnerMember(member)"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
              <!-- Job title view (default) -->
              <span class="member-job" *ngIf="!mobileShowAllTags && member.jobTitle?.trim()">{{ member.jobTitle }}</span>
              <span class="member-job missing" *ngIf="!mobileShowAllTags && !member.jobTitle?.trim()">No job title</span>
              <!-- Tags view (expanded) -->
              <div class="member-tags-edit" *ngIf="mobileShowAllTags">
                <div class="member-tags tagging" *ngIf="isMemberBeingTagged(member.id)">
                  <mat-spinner diameter="12"></mat-spinner>
                  <span class="tagging-label">Generating tags...</span>
                </div>
                <app-tag-input
                  *ngIf="!isMemberBeingTagged(member.id)"
                  [tags]="member.tags || []"
                  [allTags]="allTags"
                  (tagsChange)="saveMemberTags(member, $event)"
                  [compact]="true"
                  placeholder="Add tags...">
                </app-tag-input>
              </div>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Warning for missing required info -->
    <div class="validation-warning" *ngIf="teamMembers.length > 0 && membersWithIssues.length > 0">
      <mat-icon>warning</mat-icon>
      <div class="warning-text">
        <strong>{{ membersWithIssues.length }} team member{{ membersWithIssues.length === 1 ? ' needs' : 's need' }} a job title</strong>
        <p class="warning-hint desktop-only">Job titles are required so we can assign the right trainings. Click on a row to edit.</p>
        <p class="warning-hint mobile-only">Tap a member to edit their job title.</p>
      </div>
    </div>

    <!-- Chimp Fact Card -->
    <chimp-fact-card
      animationStyle="crossfade"
      [cycleInterval]="30000"
      [jobTitles]="currentJobTitles"
      contextHint="They're building their team right now. Reference the roles they're adding and why training those specific roles matters for OSHA compliance."
    ></chimp-fact-card>

    <!-- Processing Overlay -->
    <div class="processing-overlay" *ngIf="isProcessing">
      <div class="processing-content">
        <mat-spinner diameter="40"></mat-spinner>
        <p>{{ processingMessage }}</p>
      </div>
    </div>

    <div class="step-actions">
      <button
        mat-button
        class="back-btn"
        (click)="goBack()"
        [disabled]="isProcessing"
      >
        <mat-icon>arrow_back</mat-icon>
        Back
      </button>
      <button
        mat-flat-button
        color="accent"
        class="next-btn"
        [disabled]="!canProceed() || isProcessing"
        (click)="next()"
        [matTooltip]="hasUnsavedNewMember() ? 'Click the + button to add the new member first' : (!canProceed() && teamMembers.length > 0 ? 'All team members need a job title' : '')"
      >
        <mat-spinner *ngIf="isProcessing" diameter="20"></mat-spinner>
        <span *ngIf="!isProcessing">Next</span>
        <mat-icon *ngIf="!isProcessing">arrow_forward</mat-icon>
      </button>
    </div>
  </div>
</div>
